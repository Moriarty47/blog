<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <link rel="icon" href="/blog/images/m.ico"><link rel="stylesheet" media="print" href="/blog/print.css"><title>LOFT</title><meta name="description" content="LOFT">
    <link rel="preload" href="/blog/assets/style-52786e27.css" as="style"><link rel="stylesheet" href="/blog/assets/style-52786e27.css">
    <link rel="modulepreload" href="/blog/assets/app-bf7bc9cc.js"><link rel="modulepreload" href="/blog/assets/framework-5411b43d.js"><link rel="modulepreload" href="/blog/assets/architecture.html-bb003c77.js"><link rel="modulepreload" href="/blog/assets/architecture.html-9e3e39e0.js"><link rel="prefetch" href="/blog/assets/index.html-ae2f7e7a.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-09607301.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-0629a64a.js" as="script"><link rel="prefetch" href="/blog/assets/QA.html-df081e4e.js" as="script"><link rel="prefetch" href="/blog/assets/githubproxy.html-383ad34a.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-9dbcffc4.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-72366d4d.js" as="script"><link rel="prefetch" href="/blog/assets/advance.html-bd76e31a.js" as="script"><link rel="prefetch" href="/blog/assets/compress.html-19f867fc.js" as="script"><link rel="prefetch" href="/blog/assets/concept.html-5d747e0d.js" as="script"><link rel="prefetch" href="/blog/assets/fingerprint.html-74df5d80.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-caac1a24.js" as="script"><link rel="prefetch" href="/blog/assets/miniWebpack.html-640bc47e.js" as="script"><link rel="prefetch" href="/blog/assets/mpa.html-dc91e647.js" as="script"><link rel="prefetch" href="/blog/assets/package.html-c27afd58.js" as="script"><link rel="prefetch" href="/blog/assets/perfermance.html-2783f9cc.js" as="script"><link rel="prefetch" href="/blog/assets/resolve.html-b0ca34d9.js" as="script"><link rel="prefetch" href="/blog/assets/sourcecode.html-5e4272b7.js" as="script"><link rel="prefetch" href="/blog/assets/ssr.html-d18e6a7e.js" as="script"><link rel="prefetch" href="/blog/assets/watch.html-91a1440b.js" as="script"><link rel="prefetch" href="/blog/assets/ES10.html-b9a36ee0.js" as="script"><link rel="prefetch" href="/blog/assets/ES11.html-4b772d99.js" as="script"><link rel="prefetch" href="/blog/assets/ES12.html-b273fef0.js" as="script"><link rel="prefetch" href="/blog/assets/ES13.html-a4694136.js" as="script"><link rel="prefetch" href="/blog/assets/ES7.html-b1fd333a.js" as="script"><link rel="prefetch" href="/blog/assets/ES8.html-70de0ef1.js" as="script"><link rel="prefetch" href="/blog/assets/ES9.html-ad995181.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-b3c200c4.js" as="script"><link rel="prefetch" href="/blog/assets/gc.html-879bbaaa.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-8c49129c.js" as="script"><link rel="prefetch" href="/blog/assets/mathematicalNotation.html-280346a4.js" as="script"><link rel="prefetch" href="/blog/assets/this.html-be64c28d.js" as="script"><link rel="prefetch" href="/blog/assets/1-two-sum.html-f3a55376.js" as="script"><link rel="prefetch" href="/blog/assets/14-longest-common-prefix.html-465081db.js" as="script"><link rel="prefetch" href="/blog/assets/15-3sum.html-7e96aef9.js" as="script"><link rel="prefetch" href="/blog/assets/18-4sum.html-f5377a98.js" as="script"><link rel="prefetch" href="/blog/assets/6-zigzag-conversion.html-02434e20.js" as="script"><link rel="prefetch" href="/blog/assets/array.html-1f7213e1.js" as="script"><link rel="prefetch" href="/blog/assets/class.html-5c53e6c7.js" as="script"><link rel="prefetch" href="/blog/assets/destructuring.html-3d95d00d.js" as="script"><link rel="prefetch" href="/blog/assets/function.html-5b1890fd.js" as="script"><link rel="prefetch" href="/blog/assets/let-const.html-f4c74b49.js" as="script"><link rel="prefetch" href="/blog/assets/module.html-2eb7c0e9.js" as="script"><link rel="prefetch" href="/blog/assets/object.html-1e8d1a47.js" as="script"><link rel="prefetch" href="/blog/assets/promise.html-b0d01336.js" as="script"><link rel="prefetch" href="/blog/assets/proxy.html-6cce4ed5.js" as="script"><link rel="prefetch" href="/blog/assets/reflect.html-d0dee0d2.js" as="script"><link rel="prefetch" href="/blog/assets/string.html-a33f1c81.js" as="script"><link rel="prefetch" href="/blog/assets/symbol.html-d3d9d977.js" as="script"><link rel="prefetch" href="/blog/assets/concept.html-19390284.js" as="script"><link rel="prefetch" href="/blog/assets/implementation.html-f677d051.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-37c96fc2.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-2c7734b5.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-2a7064dc.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-472548ee.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-bbff9a7b.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-537e5be5.js" as="script"><link rel="prefetch" href="/blog/assets/QA.html-a69c1aa2.js" as="script"><link rel="prefetch" href="/blog/assets/githubproxy.html-15702a66.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-3397593f.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-e247f25c.js" as="script"><link rel="prefetch" href="/blog/assets/advance.html-ce0e3ae7.js" as="script"><link rel="prefetch" href="/blog/assets/compress.html-18eb6643.js" as="script"><link rel="prefetch" href="/blog/assets/concept.html-c25f52f1.js" as="script"><link rel="prefetch" href="/blog/assets/fingerprint.html-2d7c877c.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-f3398cb3.js" as="script"><link rel="prefetch" href="/blog/assets/miniWebpack.html-7b84d436.js" as="script"><link rel="prefetch" href="/blog/assets/mpa.html-eef62d46.js" as="script"><link rel="prefetch" href="/blog/assets/package.html-e2375368.js" as="script"><link rel="prefetch" href="/blog/assets/perfermance.html-c8dd4b3c.js" as="script"><link rel="prefetch" href="/blog/assets/resolve.html-088c6ba8.js" as="script"><link rel="prefetch" href="/blog/assets/sourcecode.html-d56c3ff3.js" as="script"><link rel="prefetch" href="/blog/assets/ssr.html-f6260664.js" as="script"><link rel="prefetch" href="/blog/assets/watch.html-899fa7db.js" as="script"><link rel="prefetch" href="/blog/assets/ES10.html-7774aa09.js" as="script"><link rel="prefetch" href="/blog/assets/ES11.html-ba657adf.js" as="script"><link rel="prefetch" href="/blog/assets/ES12.html-891ac07a.js" as="script"><link rel="prefetch" href="/blog/assets/ES13.html-8baa9a07.js" as="script"><link rel="prefetch" href="/blog/assets/ES7.html-b39e40d3.js" as="script"><link rel="prefetch" href="/blog/assets/ES8.html-6543214d.js" as="script"><link rel="prefetch" href="/blog/assets/ES9.html-2379df8e.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-79c64d37.js" as="script"><link rel="prefetch" href="/blog/assets/gc.html-92db9a5b.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-0d3d37f3.js" as="script"><link rel="prefetch" href="/blog/assets/mathematicalNotation.html-ac26ff78.js" as="script"><link rel="prefetch" href="/blog/assets/this.html-f3621cf1.js" as="script"><link rel="prefetch" href="/blog/assets/1-two-sum.html-3ff91204.js" as="script"><link rel="prefetch" href="/blog/assets/14-longest-common-prefix.html-073b04b3.js" as="script"><link rel="prefetch" href="/blog/assets/15-3sum.html-eb2e5c75.js" as="script"><link rel="prefetch" href="/blog/assets/18-4sum.html-946c996f.js" as="script"><link rel="prefetch" href="/blog/assets/6-zigzag-conversion.html-d320ed4d.js" as="script"><link rel="prefetch" href="/blog/assets/array.html-f54cd776.js" as="script"><link rel="prefetch" href="/blog/assets/class.html-b1d437e8.js" as="script"><link rel="prefetch" href="/blog/assets/destructuring.html-700158ce.js" as="script"><link rel="prefetch" href="/blog/assets/function.html-01981adc.js" as="script"><link rel="prefetch" href="/blog/assets/let-const.html-164e398b.js" as="script"><link rel="prefetch" href="/blog/assets/module.html-09065d86.js" as="script"><link rel="prefetch" href="/blog/assets/object.html-4e725ea9.js" as="script"><link rel="prefetch" href="/blog/assets/promise.html-ef7029a9.js" as="script"><link rel="prefetch" href="/blog/assets/proxy.html-69408401.js" as="script"><link rel="prefetch" href="/blog/assets/reflect.html-82e27965.js" as="script"><link rel="prefetch" href="/blog/assets/string.html-682b4bea.js" as="script"><link rel="prefetch" href="/blog/assets/symbol.html-1d32cc56.js" as="script"><link rel="prefetch" href="/blog/assets/concept.html-c7b8ce71.js" as="script"><link rel="prefetch" href="/blog/assets/implementation.html-937cb1be.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-0018c0ee.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-b2423981.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-be216922.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-78eccbaa.js" as="script"><link rel="prefetch" href="/blog/assets/Playground-3eb19026.js" as="script"><link rel="prefetch" href="/blog/assets/index-e3112853.js" as="script"><link rel="prefetch" href="/blog/assets/CodeLink-dd177f41.js" as="script"><link rel="prefetch" href="/blog/assets/CodeTool-4b08e5c5.js" as="script"><link rel="prefetch" href="/blog/assets/index-4bed0a7c.js" as="script"><link rel="prefetch" href="/blog/assets/index-7d6bcf76.js" as="script"><link rel="prefetch" href="/blog/assets/index-37fe586b.js" as="script"><link rel="prefetch" href="/blog/assets/index-94db7077.js" as="script"><link rel="prefetch" href="/blog/assets/katex-21dcf7db.js" as="script"><link rel="prefetch" href="/blog/assets/mermaid.core-905ae0d6.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container page-indent"><!--[--><header class="navbar" style="visibility:unset;"><div class="toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/blog/" class=""><!----><span class="site-name can-hide">LOFT</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/blog/" class="" aria-label="LOFT"><!--[--><!--]--> LOFT <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/playground" class="" aria-label="游乐场"><!--[--><!--]--> 游乐场 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="文章"><span class="title">文章</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="文章"><span class="title">文章</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/JSBooks/ECMAScript/" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/Leetcode/Array/1-two-sum.md" class="" aria-label="Leetcode"><!--[--><!--]--> Leetcode <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/Bundler/" class="" aria-label="构建工具"><!--[--><!--]--> 构建工具 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/Tutorial/" class="" aria-label="解决方案及教程"><!--[--><!--]--> 解决方案及教程 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="更多"><span class="title">更多</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="更多"><span class="title">更多</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/resume" class="" aria-label="简历"><!--[--><!--]--> 简历 <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="切换颜色"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/blog/" class="" aria-label="LOFT"><!--[--><!--]--> LOFT <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/playground" class="" aria-label="游乐场"><!--[--><!--]--> 游乐场 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="文章"><span class="title">文章</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="文章"><span class="title">文章</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/JSBooks/ECMAScript/" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/Leetcode/Array/1-two-sum.md" class="" aria-label="Leetcode"><!--[--><!--]--> Leetcode <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/Bundler/" class="" aria-label="构建工具"><!--[--><!--]--> 构建工具 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/Tutorial/" class="" aria-label="解决方案及教程"><!--[--><!--]--> 解决方案及教程 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="更多"><span class="title">更多</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="更多"><span class="title">更多</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/resume" class="" aria-label="简历"><!--[--><!--]--> 简历 <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active">JavaScript <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item">ECMAScript新特性 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/blog/JSBooks/ECMAScript" class="sidebar-item" aria-label="新特性简介"><!--[--><!--]--> 新特性简介 <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item collapsible">ES6新特性 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/blog/JSBooks/ECMAScript/ES6/let-const.md" class="sidebar-item" aria-label="let,const 声明"><!--[--><!--]--> let,const 声明 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES6/symbol.md" class="sidebar-item" aria-label="Symbol 基本数据类型"><!--[--><!--]--> Symbol 基本数据类型 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES6/string.md" class="sidebar-item" aria-label="字符串扩展"><!--[--><!--]--> 字符串扩展 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES6/destructuring.md" class="sidebar-item" aria-label="变量的解构赋值"><!--[--><!--]--> 变量的解构赋值 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES6/array.md" class="sidebar-item" aria-label="Array 扩展"><!--[--><!--]--> Array 扩展 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES6/object.md" class="sidebar-item" aria-label="Object 扩展"><!--[--><!--]--> Object 扩展 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES6/function.md" class="sidebar-item" aria-label="Function 扩展"><!--[--><!--]--> Function 扩展 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES6/class.md" class="sidebar-item" aria-label="Class 类"><!--[--><!--]--> Class 类 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES6/proxy.md" class="sidebar-item" aria-label="Proxy"><!--[--><!--]--> Proxy <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES6/reflect.md" class="sidebar-item" aria-label="Reflect"><!--[--><!--]--> Reflect <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES6/promise.md" class="sidebar-item" aria-label="Promise"><!--[--><!--]--> Promise <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES6/module.md" class="sidebar-item" aria-label="Module"><!--[--><!--]--> Module <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/blog/JSBooks/ECMAScript/ES7.md" class="sidebar-item" aria-label="ES7新特性"><!--[--><!--]--> ES7新特性 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES8.md" class="sidebar-item" aria-label="ES8新特性"><!--[--><!--]--> ES8新特性 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES9.md" class="sidebar-item" aria-label="ES9新特性"><!--[--><!--]--> ES9新特性 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES10.md" class="sidebar-item" aria-label="ES10新特性"><!--[--><!--]--> ES10新特性 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES11.md" class="sidebar-item" aria-label="ES11新特性"><!--[--><!--]--> ES11新特性 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES12.md" class="sidebar-item" aria-label="ES12新特性"><!--[--><!--]--> ES12新特性 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/ECMAScript/ES13.md" class="sidebar-item" aria-label="ES13新特性"><!--[--><!--]--> ES13新特性 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item active">JavaScript基础 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/blog/JSBooks/JavaScript" class="router-link-active sidebar-item" aria-label="JavaScript实现"><!--[--><!--]--> JavaScript实现 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/JavaScript/this.md" class="sidebar-item" aria-label="this指向"><!--[--><!--]--> this指向 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/JavaScript/gc.md" class="sidebar-item" aria-label="垃圾回收机制"><!--[--><!--]--> 垃圾回收机制 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/JavaScript/Vue原理/index.md" class="sidebar-item" aria-label="Vue原理"><!--[--><!--]--> Vue原理 <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item active">React <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/blog/JSBooks/JavaScript/React/concept.md" class="sidebar-item" aria-label="理念"><!--[--><!--]--> 理念 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/JavaScript/React/architecture.md" class="sidebar-item active" aria-label="架构"><!--[--><!--]--> 架构 <!--[--><!--]--></a><!----></li><li><a href="/blog/JSBooks/JavaScript/React/implementation.md" class="sidebar-item" aria-label="实现"><!--[--><!--]--> 实现 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/blog/JSBooks/JavaScript/mathematicalNotation.md" class="sidebar-item" aria-label="数学标记"><!--[--><!--]--> 数学标记 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><!----><!--[--><!-- name="fade-slide-y" --><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><!--[--><div><h2 id="架构" tabindex="-1"><a class="header-anchor" href="#架构" aria-hidden="true">#</a> 架构</h2><center><p><img src="/blog/assets/stack-83e2dfcc.png" alt="运行栈"></p></center><center>运行栈</center><p>图中三部分所做的工作其实就是<strong>调度器</strong>、<strong>调和器</strong>、<strong>渲染器</strong>所做的工作。</p><center><p><img src="/blog/assets/createFiberNode-0253b967.png" alt="图中标记1区域"></p></center><center>图中标记1区域</center><p>首次执行 <code>ReactDOM.render</code> 时，会创建整个应用的根节点 <code>FiberRootNode</code> ，还会创建当前应用的根节点 <code>FiberNode</code>(<code>createHostRootFiber -&gt; createFiber -&gt; FiberNode</code>)</p><center><p><img src="/blog/assets/unbatchedUpdates-92208ec3.png" alt="图中标记2区域"></p></center><center>图中标记2区域</center><p>创建完根节点后，进入首次渲染：</p><p><code>scheduleUpdateOnFiber</code> 在 Fiber 上调度更新；</p><p><code>performSyncWorkOnRoot</code> 调度成功后，在根节点执行更新；</p><p>创建 <code>workInProgress</code> 树的流程可以类比为递归的流程：</p><ul><li>“递”阶段: <code>beginWork</code></li><li>“归”阶段: <code>completeWork</code></li></ul><p>在 React 内部，</p><ul><li><code>renderRootSync</code> 方法即调和器的执行过程，所做的工作流程被称为 <code>render</code> 阶段，</li><li><code>commitRoot</code> 方法即渲染器的执行过程， 所做的工作流程被称为 <code>commit</code> 阶段。</li></ul><h3 id="基本概念" tabindex="-1"><a class="header-anchor" href="#基本概念" aria-hidden="true">#</a> 基本概念</h3><h4 id="jsx" tabindex="-1"><a class="header-anchor" href="#jsx" aria-hidden="true">#</a> JSX</h4><p>使用 <code>@babel/plugin-transform-react-jsx</code> babel 插件对 jsx 进行编译。</p><div class="code-tool-container language-jsx" data-ext="jsx"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="jsx"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>moriarty<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Moriarty</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">// === babel 插件编译后</span>

<span class="token comment">/*#__PURE__*/</span>
React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">/*#__PURE__*/</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;p&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;moriarty&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;Moriarty&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><!--]--><!----></div></div><p><code>React.createElement(type, config, children)</code> 接收三个参数，根据给定的 <code>type</code> 创建并返回一个新的 <code>ReactElement</code></p><p>对于 <code>Class Component </code>， <code>babel</code> 插件编译如下：</p><div class="code-tool-container language-jsx" data-ext="jsx"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="jsx"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-jsx"><code><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Components</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&#39;A&#39;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token constant">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">&#39;B&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">A</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">B</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">// === babel 插件编译后</span>

<span class="token keyword">var</span> <span class="token constant">A</span> <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_React$Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">_inherits</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> _React$Component<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> _super <span class="token operator">=</span> <span class="token function">_createSuper</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">_super</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">_createClass</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&#39;render&#39;</span><span class="token punctuation">,</span>
    <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">&#39;A&#39;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token constant">A</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span>Component<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token constant">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">&#39;B&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*#__PURE__*/</span>
React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">/*#__PURE__*/</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">/*#__PURE__*/</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><!--]--><!----></div></div><h4 id="reactcomponent-与-reactelement-关系" tabindex="-1"><a class="header-anchor" href="#reactcomponent-与-reactelement-关系" aria-hidden="true">#</a> <code>ReactComponent</code> 与 <code>ReactElement</code> 关系</h4><ul><li><code>React.createElement</code> 调用的结果即为 ReactElement；</li><li>上述代码中的 <code>class A</code> 与 <code>function B</code> 即为 <code>ReactComponent；</code></li><li><code>ReactComponent</code> 与 <code>ReactElement</code> 的关系是 <code>ReactComponent</code> 会作为 <code>React.createElement</code> 方法的第一个 <code>type</code> 参数。</li></ul><h4 id="jsx-与-fiber-关系" tabindex="-1"><a class="header-anchor" href="#jsx-与-fiber-关系" aria-hidden="true">#</a> jsx 与 Fiber 关系</h4><p>在首次渲染时会创建 <code>workInProgress</code> Fiber 树，创建 Fiber 节点的依据就是组件返回的 jsx 对象 ，在更新时已经存在一棵 <code>current</code> Fiber 树，所以在生成 <code>workInProgress</code> Fiber 节点时，会将组件返回的 jsx 对象与这个组件对应的 <code>current</code> Fiber 节点做对比，根据对比的结果生成这个组件对应的 <code>workInProgress</code> Fiber 节点。</p><h4 id="计数器简单实现" tabindex="-1"><a class="header-anchor" href="#计数器简单实现" aria-hidden="true">#</a> 计数器简单实现</h4><br><div class="code-tool-container language-jsx" data-ext="jsx"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="jsx"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-jsx"><code><span class="token keyword">class</span> <span class="token class-name">ClickCounter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleClick</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> + 1 </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><!--]--><!----></div></div><p>上述代码是一个简单的计数器组件，当点击按钮时，组件的状态在 <code>handleClick</code> 中更新，并触发 <code>span</code> 元素的文本更新。</p><p>React 在<strong>调和过程</strong>中，执行了各种活动，例如， React 在当前应用的首次渲染和状态更新后执行的高级操作：</p><ul><li>更新 <code>ClickCounter</code> 组件状态 <code>state</code> 中的 <code>count</code> 属性；</li><li>查找并比较 <code>ClickCounter</code> 的子元素和它们的 <code>props</code>；</li><li>更新 <code>span</code> 元素的属性。</li></ul><p><strong>调和过程</strong>中还执行了一些其他的活动，例如调用生命周期函数或者更新 <code>refs</code> ，所有的这些活动在 Fiber 架构中统称为工作。这一类型的工作通常取决于 <code>ReactElement</code> 的类型。例如，对于一个 class 组件来说，React 需要创建一个实例，但对于函数组件来说，则不需要这步操作。React 中有很多类型的组件，class 组件，函数组件，Host 组件(DOM 节点)和 Portal 组件等等。React 组件是通过 <code>createElement</code> 函数的第一个参数定义的，这个函数通常在 <code>render</code> 函数中调用用于创建一个 <code>ReactElement</code>。</p><h4 id="reactelement-与-fiber-节点-的关系" tabindex="-1"><a class="header-anchor" href="#reactelement-与-fiber-节点-的关系" aria-hidden="true">#</a> <code>ReactElement</code> 与 Fiber 节点 的关系</h4><p>React 的 jsx 模板如下:</p><div class="code-tool-container language-jsx" data-ext="jsx"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="jsx"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-jsx"><code><span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> + 1 </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><!--]--><!----></div></div><p>通过编译后，如下：</p><div class="code-tool-container language-javascript" data-ext="js"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
      <span class="token string">&#39;button&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">onClick</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&#39; + 1 &#39;</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
      <span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&#39;2&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><!--]--><!----></div></div><p>React 调用 <code>render</code> 函数后会创建如下数据结构：</p><div class="code-tool-container language-javascript" data-ext="js"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;button&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">&#39; + 1 &#39;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&#39;2&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre><!--]--><!----></div></div><p>在调和过程中，从 <code>render</code> 方法返回的每个 <code>ReactElement</code> 的数据都被合并到 Fiber 节点树中。每个 <code>ReactElement</code> 都有一个对应的 Fiber 节点。与 <code>ReactElement</code> 不同的是，Fiber 节点不会在每次渲染时重新创建，而是保存了组件状态和 DOM 的可变数据结构。</p><p>根据 <code>ReactElement</code> 的类型，框架需要执行不同的活动， 对于 class 组件需要调用生命周期和 <code>render</code> 方法，而对于 <code>span</code> Host 组件(DOM 节点)需要执行 DOM mutation。可以看出，每个 <code>ReactElement</code> 都被转换为相应描述需要完成工作的类型的 Fiber 节点。</p><p>Fiber 实际是一种数据结构，它表示要做的工作，或者工作单元。Fiber 架构提供了一种方便的方法来追踪、调度、暂停和终止工作。</p><p>当 <code>ReactElement</code> 首次被转换为 Fiber 节点时，React 会在 <code>createFiberFromTypeAndProps</code> 函数中使用来自元素的数据创建一个 Fiber 节点；在后续的更新中，React 复用之前创建的 Fiber 节点，只使用来自对应 <code>ReactElement</code>的数据更新必要的属性。React 可能还需要根据节点的 <code>key</code> 属性移动层次结构中的节点或当 <code>render</code> 方法不再返回相应的 <code>ReactElement</code> 则删除对应的节点。</p><p>React 为每个 <code>ReactElement</code> 创建了一个 Fiber 节点，通过这些 <code>ReactElement</code> 所构成的树，对应构成了其 Fiber 节点树。</p><!----><h4 id="current-树-和-workinprogress-树" tabindex="-1"><a class="header-anchor" href="#current-树-和-workinprogress-树" aria-hidden="true">#</a> <code>current</code> 树 和 <code>workInProgress</code> 树</h4><p>首次渲染完成后，React 最终得到一棵 Fiber 节点树，它表示了用于渲染 UI 的应用程序的状态。这棵树通常被称为 <code>current</code> 树；当 React 开始更新时，它会构建一个 <code>workInProgress</code> 树，这棵树表示了要刷新到屏幕上的未来状态。</p><p>所有的工作 都在 <code>workInProgress</code> 树上执行。当 React 遍历 <code>current</code> 树时，它会为每一个现有的 Fiber 节点创建一个用于构成 <code>workInProgress</code> 树的 <code>alternate</code>节点。这个节点是使用 <code>render</code> 方法返回的 <code>ReactElement</code> 中的数据创建的。一旦更新被处理并且所有相关工作完成，React 会将 <code>workInProgress</code> 树作为备用树并准备刷新到屏幕上，一旦这个树刷新到屏幕上，它就变为了 <code>current</code> 树。</p><p>React 的核心原则之一是 <strong>一致性</strong>。 React 总是一次更新 DOM，不会显示部分更新结果。<code>workInProgress</code> 树作为用户不可见的草稿，React 会先处理所有组件，然后统一将它们的更改刷新到屏幕上。</p><p>React 源码中，有许多函数会从 <code>current</code> 树和 <code>workInProgress</code> 树中获取 Fiber 节点。如：</p><div class="code-tool-container language-javascript line-numbers-mode" data-ext="js"><div class="window-controls" style="display:block;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><!--]--><!----></div></div><p>每个 Fiber 节点会在 <code>alternate</code> 属性中保存另外一棵树的对应节点的引用，<code>current</code> 树中的节点指向 <code>workInProgress</code> 树中的节点，反之亦然。</p><h4 id="副作用-side-effects" tabindex="-1"><a class="header-anchor" href="#副作用-side-effects" aria-hidden="true">#</a> 副作用(Side-effects)</h4><p>我们可以把 React 中的组件想象为一个函数，它使用 <code>state</code> 和 <code>props</code> 来计算 UI 表示，任何其他活动(改变 DOM 或调用生命周期方法)都应被视为<a href="https://legacy.reactjs.org/docs/hooks-overview.html#effect-hook" target="_blank" rel="noopener noreferrer">副作用<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><p>你可以看到大多数 <code>state</code> 和 <code>props</code> 更新将导致副作用。由于应用的副作用是一种工作机制，除了更新以外，使用 Fiber 节点是来跟踪副作用很方便。每个 Fiber 节点都有与之对应的副作用，它们被编码在 <code>effectTag</code> 字段中。</p><p>Fiber 中的副作用基本定义是：在处理完更新之后需要为实例完成的工作。对 Host 组件(DOM 节点)来说，工作包括添加、更新或删除元素。对 class 组件来说，React 可能需要更新 <code>refs</code> 并调用 <code>componentDidMount</code> 和 <code>componentDidUpdate</code> 生命周期方法，其他类型的 Fiber 节点也有其他的副作用。</p><h4 id="副作用表" tabindex="-1"><a class="header-anchor" href="#副作用表" aria-hidden="true">#</a> 副作用表</h4><p>React 处理更新的速度非常快，为了达到这样的性能水平，它采用了一些有趣的技术。其中一项就是 <strong>维护一个具有快速迭代副作用的 Fiber 节点的线性列表</strong>，迭代线性列表比树要快得多，也无需花费时间在没有副作用的情况下。</p><p>这个列表的目的是：<strong>标记具有与之相关的 DOM 更新或其他副作用的节点</strong>。这个列表是 <code>finishedWork</code> 树的子集，并且使用 <code>nextEffect</code> 属性来链接而不是 <code>current</code> 树和 <code>workInProgress</code> 树中的 <code>child</code> 属性。</p><p><a href="https://overreacted.io/" target="_blank" rel="noopener noreferrer">Dan Abramov<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>将副作用表类比为一棵圣诞树，圣诞灯将所有有效的节点绑在一起。例如：一个更新使得 <code>c2</code> 节点插入 DOM 之中，<code>d2</code> 和 <code>c1</code> 更改了属性，同时 <code>b2</code> 节点触发了生命周期方法。副作用表将会连接这些更改，这样 React 就会跳过其他的节点。如下图：</p><center><p><img src="/blog/assets/effect-list-e0e7bcd7.png" alt="副作用表"></p></center><p>在遍历副作用表时，React 使用 <code>firstEffect</code> 指针来找出列表开始的位置，如下图：</p><center><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAsgAAABnCAYAAAAdfrRkAAAACXBIWXMAAAsSAAALEgHS3X78AAANOUlEQVR42u3dT44cSRmGcd+CA/gIHMI7JG7ACslcATjALID1LGZtBKwRGySEFwiJDUJIszELQCMhIRBiMDbY0/hrHEU4iMiM7K6M/NO/R0p5prq6qrvy+b58MzIy+tENAAAAgAuPfAQAAACAgAwAAAAIyAAAAICADAAAAAjIAAAAgIAMAAAACMgAAACAgLzXD/PRo8v2/Pnz3f18L168+OBnjP8P4mfNHwfW4NmzZxfHHj9+fHn8o48+ujz+5MkTHxSG9edWTwSuSavHPX369PJ4/DcE5FMS0pcH9yT/2mE53jdv8q2GH6GkVoTxvChg4L7BI9/yEJyCSITknHRytscTSuyfPGCUW+5UrT9P9URgjvLkKt9y11o9Lg0YOCkTkB9EoZQhc1RAjiafh5EaqUjLgJKKVEDBfdyfCxlpBKU8GKQaAe4zOHCX/tzqiUAPyZ+5waVWjwt3547bEJBPG5CvyVSQ3XNAbgUjHIvWftx7QBbAz91f9xyQDT6c5ySsdnzde0CO1zZlTUA+zJnklgE5fX95MEjBRUDGmgE5HSTK7+8JOAKygHyfgNzqz62eKCDjmgG55WjPcVtAFpAPXzyt+Ue1UJEKKp+0n76eP5Y31rn5nXOFFl8rv781dy8v9vJ3azWC8vXjwNCan6Vgr+NcbOVn3No/U/sxHcTL701Oze3HuYDc+v6Wf3mYmPra1OvHY+WNp26EuW7oi88496rVf/IbM2vPqz2Wn7S37q9IPXMuILf6c6snlidWc960amuuZ+PuoS/2RVnfrZOcqR6SPCu/NzlSulvu47mAPNWDppxu9bSe16/liLnPCALyqrQKpRWQa0GxfG78mzfU0SPI5Wu2glD5u6TnzY084jonZXP7t2c/ptcrT9RqB5MRI8i116z9frW6i6/X7hLHdQNyuS+melp5s1zN27QPa/t+9Ahy7TVrv1+t7+aOG0FeJyC3VsHJP+feHpJeb6pPjRxBrr1m7fer/S7xvPz3NYIsIB82INcCxFTInQvIc6PBSwJyKwyVj/eEXwF5vYBc8yBviL37MR1M8lHpMvDOBeS50eAlAbl1QCof75nDJyCvE5BbfaR0quyJtcfzE7SpE6apgDw1GrwkILf6bPl4T/gVkNcJyLWar5309/SQ5EY+Kl16MheQ51aPWhKQW6G2fLwn/ArIAvIhA3JttC0107lLlSNGkFsNofwZegKKgLxOQK597mVD7N2P+X5qOThyBLn1emXYXfK+uG5ALvtQ6cdUv2qNELem0owcQW75Ut7Q1+OVgLxOQK6FvtKp3h6SP9aaAjhqBHnO8/Tc3kUBBGQB+TQBOW+otQPF6IDcOjPOn9tTgALy2IBcjrD27Mf8+1uNd3RAntqWHCQE5LEBuRxhbW2tKxQ1r7cIyK0tPbdncEBAHhuQ88d7ekit59Tm6Y4OyHPryveuviIgC8inCsi1gu0ZkRk1gnyX9xWQtw3IvTcG5QGlZ1rG2gF57vWWvi+2Ccg94TDty9YJ2h5GkO/yvgLytgG594bctM/L+chbBeS51+t9XwFZQD5tQF4y5+3aAbk31LZCj4C8j4Dc+9nn/ubzkbcKyNc8QROQtwnIS9aGz/djecPo6IDcG2p7lscUkLcLyL09JHcgn4+8RUBeEmp7VoQSkAXk0wTk8nnlgX2qGNdYxaJ2uTOeUzvjLYuwZ3UFrB+Qe/djK1jXgkO5H9cIyK0DVXmXdm2JurQ02JIgg+sH5Hyf16bypMdawbrWU1rzQ6+9ikVtJLFcnadVW2lpxCUBCtcPyL09pPy+mrOt3rVGQG4tuxk/Q21li7JH11YngoB8+IBcuyO2dZm7drY8N8/0Ln8opFwdY2p+4NTc1nxen3Voxwbkuf04tczf1M0s5UFmbq7f0j8UUvNq6ubWqfmFeX0IK+MCctmzyv4wt2JKbUm/lldT84Xv8odCaj21NZI3tdZsq2dj3YDc00NaPal14lPu46k5w7V7QXr7dS0LTN0XMnV8nltHHgIyAAAAICADAAAAAjIAAAAgIAMAAAACMgAAACAgAwAAAAIyAAAAICADAAAAAjIAAAAgIAMAAAACMgAAACAgAwAAAAIyAAAAICADAAAAAjIAAAAgIAMAAAACMgAAACAgAwAAAAIyAAAAICADAAAAAjIAAAAAARkAAAAQkAEAAAABGQAAALhTQP7bN75ke79hPLzjH/e4xz/+gXtbuycgK1KFyj9wj3v84x/3uCcgK1KFyj9wj3v84x84JyArUoXKP3CPe/zjH7gnICtShco/cI97/OMfuCcgK1KFyj9wj3v84x+4JyArUoXKP3CPe/zjH7gnICtShco/cI97/OMfuCcgK1KFyj9wj3v84x+4JyArUoXKP3CPe/zjH7gnICtShco/cI97/OMfuCcgK1KFauMf97jHP/6BewKyIgX/+Mc97vHPBu4JyIoU/OMf97gH3vGPewKyIoVC5R/3uAf+8Y97ArIihULlH/e4B/7xj3sCsiKFQuUf97gH/vGPewKyIoVC5R/3uAf+8Y97ArIixbEL9c0ff3v7/i8/+Tr/uKf34VT+vf3Ti0M5Dr1PQF6wvf7ZJzdfvH55uylShbrWAeSfP/jm5bG/f+vLN//65Q9v3v71s8vPF/8dLvKPeyO2OGH74vO/DD95w8MOyHof97bMemnAKoj+9+9f/+TWSQG5Uqj5hzXyZ9w7r3/x/Zu3f/69Ql0pIKeDQ5yUxddTUAmiYB0kzuXi3npfOJaTu8m98/XBPQVkvY97m/S8T3/+vxOyd959cIL27v8F5MboSf7BOUj8l5cff+3253z1o2+fJijvKSCHe+WIyZvf/epy4HCQOJeLexoUSD7mBwkB+dx9cE8BWe/j3lZTHcvR4vDw8nkPuIp2mIAcH1QUYzowCMj14kzbGYLyngJyK7yMGtE7Ykg5sot76XvhVRCXuJe4yb1j98G9z0HW+7i32fH5/SDB6KsXmwTkKK7aHJPyeZ9/9ysfnEkIyNPFeYagvPY+Dady9+LAEWelS0KIg8Q5XRzVV179+Dv/N7czheEURMLTpSdv3Dt2HxwVkG8Hnt5fmY1/c/f0Pu5t2fvm/D19QE5TJVIozos1vtbzgztITBenUbx2OI4rEkFcLkzupZs/exp/vMYoD88QUo7k4sh5xXn/m5tCISA/jD44IiCHa9Hr4lgbW+p7PcFD7+Pe6N6XT/kZ1QM3DcgxeleeMcSISc8KFUe5HGC7oxuffbru67+fQ1ceDNLjPQWYijw8HlGovDjPlgJGNPvyjuyYZ9e6S3uLgGw7V+/LA3J+dSKuniXmVgkY2ftsel855WzUCmabT7G46xwpAdlB4j5bGi2pFWPPmWw+Ap0fZARk25IRlCWXtAVkve+ax9faTU5pyllc/t5L77PpfeWxeYslBjcLyFGo8WGV0yxMsbje5Z20/eN7X71584ffPOgpFukMtrVUTE8ISYV6lyJ/6Je5j+DiXm4ENcXiYfbBrQagUniZmmah93Fvi96XpuSOvGqxaUDOl25buqME5GXFeaRgvPa+TZdp7hqQ0zSM+Jd/53RRQOaegKz3cW8fvS8t7xYnZ6P+SMjmATmF4zgTzX/pPU6xOGpxHjEY73kE+XKAGDz37gwhxdULAZl7xw3Ieh/3tuh9KRzX5iyfNiBPjeIJyPcvziMH4xH7duo9WnOQ0wFi9Fns0UOKqxfHnoPMvXMG5Nr84TQHWe/j3h563yUcv3455A+D7CYgpztmo+DK4JxuABCQlxfnGYLxiH2bDgRlkbZWsdjqEs+RQ4qrF/P9rzYqEjdItW5+EpAfRh8ctYpF7t7FyWKFAL2Pe1v0vtspuO9XNNsiHG8+xSKN1EXBxllF/ucry/ePDyjdxJfOQNKloNjWvqtx77z66cenCcajTtBa6yCXoyj58kfh7O2f/C22uXW7H1JIOYOLQ1YrSP1uYi3QOIDkfS9NS0vOjl4sn3vnCMi3fayxDnJ+LNX7uLdV70s+xnNq3rWmSJ4mIEfzjw8q/yDSahbl+8fjU8T3KtJzMeJMNo2mpNARZ6/Jv3TWmh8kWqxdrDjfQaL8S2bJo/yqRo97ay+1hRMG5HdbefyNgFIu76b3cW+r3pe83PJn3TQgH2nDeQuVf+Ae9/jHP3BPQFakCpV/4B73+Mc/cE9AVqQKlX/gHvf4xz9wT0BWpAqVf+Ae9/jHP3BPQFakCpV/4B73+Mc/cE9AVqQKlX/gHvf4xz9wT0BWpAqVf+Ae9/jHP3BPQFakCpV/4B73+Mc/cE9AVqQKlX/gHvf4xz9wT0BWpArVxj/ucY9//AP3BGRFCv7xj3vc45+Nf9wTkBUpFCr/uMc98I9/3BOQFSkUKv+4xz3wj3/cE5AVKRQq/7jHPfCPf9wTkBUpFCr/uMc98I9/3BOQFSkUKv+4xz3wj3/cE5AVKRQq/7jHPfCPf9wTkBUpFCr/uMc98I9/3BOQFSkUKv+4xz3wj3/ce2ABGQAAAHjICMgAAACAgAwAAAAIyAAAAMAs/wEypaDgmrOSYwAAAABJRU5ErkJggg==" alt="副作用表指针"></p></center><h4 id="fiber-树的根节点" tabindex="-1"><a class="header-anchor" href="#fiber-树的根节点" aria-hidden="true">#</a> Fiber 树的根节点</h4><p>每个 React 应用都有一个或多个 DOM 元素作为其容器。</p><div class="code-tool-container language-javascript" data-ext="js"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code><span class="token keyword">const</span> domContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#container&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>ClickCounter<span class="token punctuation">)</span><span class="token punctuation">,</span> domContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><!--]--><!----></div></div><p>React 为每一个容器创建一个 Fiber Root 对象。你可以使用 DOM 元素中的属性引用访问它。</p><div class="code-tool-container language-javascript" data-ext="js"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code><span class="token keyword">const</span> fiberRoot <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&#39;#container&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_reactRootContainer<span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>
</code></pre><!--]--><!----></div></div><p>这个 Fiber Root 对象是 React 保存 Fiber 树的引用的地方。Fiber 树被存储在 Fiber Root 对象的 <code>current</code> 属性中。</p><div class="code-tool-container language-javascript" data-ext="js"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code><span class="token keyword">const</span> hostRootFiberNode <span class="token operator">=</span> fiberRoot<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
</code></pre><!--]--><!----></div></div><p>Fiber 树起始于一个特殊类型的 Fiber 节点 HostRoot，它是内部创建的，用来充当顶层组件的父组件。</p><div class="code-tool-container language-javascript" data-ext="js"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code>fiberRoot<span class="token punctuation">.</span>current<span class="token punctuation">.</span>stateNode <span class="token operator">===</span> fiberRoot<span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre><!--]--><!----></div></div><p>你可以通过组件实例 <code>_reactInternals</code> 的属性获取对应的 Fiber 节点。</p><div class="code-tool-container language-javascript" data-ext="js"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code>componentInstance<span class="token punctuation">.</span>_reactInternals<span class="token punctuation">;</span>
</code></pre><!--]--><!----></div></div><h4 id="fiber-节点数据结构" tabindex="-1"><a class="header-anchor" href="#fiber-节点数据结构" aria-hidden="true">#</a> <a href="https://github.com/facebook/react/blob/89b610969d70d788f8c9769e3fa5b0044f5737ab/packages/react-reconciler/src/ReactFiber.old.js#L210" target="_blank" rel="noopener noreferrer">Fiber 节点数据结构<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h4><p>上述示例中 <code>ClickCounter</code> 和 <code>span</code> 元素的 Fiber 节点结构如下：</p><div class="code-tool-container language-javascript" data-ext="js"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">stateNode</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ClickCounter</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token keyword">class</span> <span class="token class-name">ClickCounter</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">elementType</span><span class="token operator">:</span> <span class="token keyword">class</span> <span class="token class-name">ClickCounter</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">alternate</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">updateQueue</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">pendingProps</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">memoizedProps</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">effectTag</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">nextEffect</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// other fields..</span>
<span class="token punctuation">}</span>

<span class="token comment">// span</span>

<span class="token punctuation">{</span>
  <span class="token literal-property property">stateNode</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">HTMLSpanElement</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">elementType</span><span class="token operator">:</span> <span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">alternate</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&#39;2&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">updateQueue</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">pendingProps</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">children</span> <span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">memoizedProps</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">children</span> <span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token literal-property property">effectTag</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">nextEffect</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// other fields..</span>
<span class="token punctuation">}</span>
</code></pre><!--]--><!----></div></div><p><code>stateNode</code></p><p>保存对组件、DOM 节点或其他与 Fiber 节点关联的 <code>ReactElement</code> 元素类型的类实例引用。一般来说，这个属性用于保存与 Fiber 相关的本地状态。</p><p><code>type</code></p><p>定义与此 Fiber 节点关联的函数或类。对于 class 组件来说，它指向构造函数；对 DOM 元素来说，它指向 HTML 标签类型字符串。</p><p><code>tag</code></p><p>定于 Fiber 的类型，它在 调和算法 中用于确定需要做什么工作。如上所述，工作取决于 <code>ReactElement</code> 的类型，<code>createFiberFromTypeAndProps</code> 函数将 <code>ReactElement</code> 映射到相应的 Fiber 节点类型。从源码中可以看出 <code>1</code> 代表 class 组件， <code>5</code> 代表 Host 组件。</p><div class="code-tool-container language-javascript" data-ext="js"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> FunctionComponent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ClassComponent <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> IndeterminateComponent <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Before we know whether it is function or class</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostRoot <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// Root of a host tree. Could be nested inside another node.</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostPortal <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// A subtree. Could be an entry point to a different renderer.</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostComponent <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostText <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Fragment <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Mode <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextConsumer <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextProvider <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ForwardRef <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Profiler <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SuspenseComponent <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> MemoComponent <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SimpleMemoComponent <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> LazyComponent <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> IncompleteClassComponent <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> DehydratedFragment <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SuspenseListComponent <span class="token operator">=</span> <span class="token number">19</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> FundamentalComponent <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ScopeComponent <span class="token operator">=</span> <span class="token number">21</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Block <span class="token operator">=</span> <span class="token number">22</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> OffscreenComponent <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> LegacyHiddenComponent <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>
</code></pre><!--]--><!----></div></div><p><code>updateQueue</code></p><p>一个包含状态更新，回调和 DOM 更新的队列。</p><p><code>memoizedState</code></p><p>用于创建输出的 Fiber 的状态。当处理更新时，它反映了当前渲染在屏幕上的状态。</p><p><code>memoizedProps</code></p><p>在之前渲染中用于创建输出的 Fiber 的属性。</p><p><code>pendingProps</code></p><p>从 <code>ReactElement</code> 的新数据中更新的属性并且需要应用到子组件或者 DOM 元素。</p><p><code>key</code></p><p>一组含有子元素的列表的唯一标识符，帮助 React 找出哪些项目从列表中被更改、添加或删除。</p><h2 id="算法" tabindex="-1"><a class="header-anchor" href="#算法" aria-hidden="true">#</a> 算法</h2><p>React 的主要执行工作在两个阶段：<code>render</code> 阶段和 <code>commit</code> 阶段。</p><p>在第一个 <code>render</code> 阶段，React 将更新应用于通过 <code>setState</code> 或 <code>React.render</code> 调度的组件并找出哪些需要在 UI 中更新。如果是首次渲染，React 会为每一个通过 <code>render</code> 方法返回的元素创建一个新的 Fiber 节点；在后续更新中，现有的 <code>ReactElement</code> 的 Fiber 节点将被重用和更新。<strong>这个阶段的结果是返回一个带有副作用的 Fiber 节点树</strong>。副作用描述了下一个 <code>commit</code> 阶段需要完成的工作。在这个阶段，React 获取一个标记有副作用的 Fiber 树并将它们应用到实例中。它会遍历副作用表并执行 DOM 更新和其他的对用户可见的更改。</p><p>需要注意的是 <strong><code>render</code> 阶段的工作可以异步执行</strong>。 React 可以根据可用时间处理一个或多个 Fiber 节点，然后暂停并保存已完成的工作，将控制权交于其他更重要的事件。之后再从它暂停的地方继续。但有时，它可能需要放弃已完成的工作，重新从头开始。这些暂停之所以成为可能是因为在此阶段执行的工作不会导致任何用户可见的更改，如 DOM 更新。</p><p>相反，<strong><code>commit</code> 阶段始终是同步的</strong>。因为此阶段执行的工作会导致用户可见的更改。如 DOM 更新。这也是为什么 React 需要一次完成它们。</p><p>调用生命周期方法是 React 执行的一种工作。有些方法在 <code>render</code> 阶段调用，有些则在 <code>commit</code> 阶段调用。</p><p>以下是在 <code>render</code> 阶段调用的方法：</p><ul><li><code>UNSAFE_componentWillMount() {} /* deprecated */</code></li><li><code>UNSAFE_componentWillReceiveProps() {} /* deprecated */</code></li><li><code>getDerivedStateFromProps() {} </code></li><li><code>shouldComponentUpdate() {} </code></li><li><code>UNSAFE_componentWillUpdate() {} /* deprecated */</code></li><li><code>render() {} </code></li></ul><p>其中一些遗留的生命周期方法在 <code>16.3</code> 版本之后的未来版本中被删除。因为在 <code>render</code> 阶段不会产生像 DOM 更新这样的副作用，因此 React 可以异步地对组件进行异步更新处理(甚至在多个线程中进行)。然而，标有不安全(<code>UNSAFE_</code>)前缀的生命周期经常被误解和微妙地滥用，开发者倾向于将带有副作用的代码放在这些方法中，这可能会导致新的异步渲染实现出现问题。虽然只有不带不安全前缀的对应项会被删除，但它们仍可能在即将到来的 <code>concurrent</code> 模式中引起问题。</p><p>以下是在 <code>commit</code> 阶段调用的方法：</p><ul><li><code>getSnapshotBeforeUpdate</code></li><li><code>componentDidMount</code></li><li><code>componentDidUpdate</code></li><li><code>componentWillUnmount</code></li></ul><p>这些方法在同步的 <code>commit</code> 阶段被执行，因此它们可能包含副作用，包括更新 DOM。</p><h3 id="render-阶段" tabindex="-1"><a class="header-anchor" href="#render-阶段" aria-hidden="true">#</a> <code>render</code> 阶段</h3><p>调和算法总是使用 <code>renderRootSync</code> 方法从最顶层的 <code>HostRoot</code> Fiber 节点开始。但是，React 会跳出(跳过)已经处理过的 Fiber 节点，直到找到工作未完成的节点。例如，当你在组件树的深处调用 <code>setState</code>，React 将从顶部开始，但很快跳过父组件，直接到达调用了 <code>setState</code> 方法的组件。</p><h4 id="工作流程的主要步骤" tabindex="-1"><a class="header-anchor" href="#工作流程的主要步骤" aria-hidden="true">#</a> 工作流程的主要步骤</h4><p>所有的 Fiber 节点都 <a href="https://github.com/facebook/react/blob/89b610969d70d788f8c9769e3fa5b0044f5737ab/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L1558" target="_blank" rel="noopener noreferrer"><code>workLoopSync</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 中被处理。<code>workLoopSync</code> 的实现如下：</p><div class="code-tool-container language-javascript" data-ext="js"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Already timed out, so perform work without checking if we need to yield.</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><!--]--><!----></div></div><p>上述代码中 <code>nextUnitOfWork</code> 保存了对 <code>workInProgress</code> 树中的 Fiber 节点的引用，当 React 遍历 Fiber 树时，它使用这个变量获知是否有其他未完成工作的 Fiber 节点，当处理完当前 Fiber 节点后，该变量要包含树中下一个 Fiber 节点的引用，要么为 <code>null</code> ，这种情况下， React 会退出 <code>workLoopSync</code> 并准备提交更改。</p><p>如下四个主要函数会在遍历 Fiber 树过程中使用到，会初始化或完成工作。</p><ul><li><code>performUnitOfWork</code></li><li><code>beginWork</code></li><li><code>completeUnitOfWork</code></li><li><code>completeWork</code></li></ul><h4 id="performunitofwork-与-beginwork" tabindex="-1"><a class="header-anchor" href="#performunitofwork-与-beginwork" aria-hidden="true">#</a> <code>performUnitOfWork</code> 与 <code>beginWork</code></h4><div class="code-tool-container language-javascript" data-ext="js"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">unitOfWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token keyword">let</span> next <span class="token operator">=</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> unitOfWork<span class="token punctuation">,</span> subtreeRenderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  unitOfWork<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>unitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    workInProgress <span class="token operator">=</span> next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* ...some works */</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/* ...other conditions */</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token punctuation">,</span>
  workInProgress<span class="token punctuation">,</span>
  Component<span class="token punctuation">,</span>
  resolvedProps<span class="token punctuation">,</span>
  renderLanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* some works */</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><!--]--><!----></div></div><p><code>performUnitOfWork</code> 从 <code>workInProgress</code> 树中接收一个 Fiber 节点，并通过调用 <code>beginWork</code> 函数开始工作。这个函数将会启动所有需要为 Fiber 节点执行活动的活动。 <code>beginWork</code> 函数总是会返回一个指向下一个需要处理的子节点的指针或者 <code>null</code>。</p><p>如果有下一个子节点，它将会被分配给 <code>workLoopSync</code> 中的 <code>next</code> 变量，但是如果没有子节点，React 则知道它到达了分支的末端，即完成当前节点。节点一旦完成，它将需要为兄弟节点执行工作并在之后回溯到父级。这是在 <code>completeUnitOfWork</code> 中完成的。</p><h4 id="completeunitofwork-与-completework" tabindex="-1"><a class="header-anchor" href="#completeunitofwork-与-completework" aria-hidden="true">#</a> <code>completeUnitOfWork</code> 与 <code>completeWork</code></h4><div class="code-tool-container language-javascript" data-ext="js"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code><span class="token comment">// 省略部分代码</span>
<span class="token keyword">function</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">unitOfWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> completedWork <span class="token operator">=</span> unitOfWork<span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token keyword">const</span> returnFiber <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>return<span class="token punctuation">;</span>

    <span class="token keyword">let</span> next<span class="token punctuation">;</span>

    next<span class="token operator">=</span> <span class="token function">completeWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> completedWork<span class="token punctuation">,</span> subtreeRenderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      workInProgress <span class="token operator">=</span> next<span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> siblingFiber <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>siblingFiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If there is more work to do in this returnFiber, do that next.</span>
      workInProgress <span class="token operator">=</span> siblingFiber<span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Otherwise, return to the parent</span>
    completedWork <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
    <span class="token comment">// Update the next thing we&#39;re working on in case something throws.</span>
    workInProgress <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span>completeWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">completeWork</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token punctuation">,</span>
  workInProgress<span class="token punctuation">,</span>
  renderLanes</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">MemoComponent</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ClassComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLegacyContextProvider</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">popLegacyContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/* ...other conditions */</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><!--]--><!----></div></div><p>当完成当前 Fiber 节点的工作后，它会检查是否有兄弟 Fiber。如果找到，React 会退出该函数并返回指向同级函数的指针，它将重新从它的兄弟开始的分支执行工作。此时，React 还没有完成其父节点的工作，<strong>只有当所有从子节点开始的分支都完成后，它才会完成父节点的工作并进行回溯</strong>。</p><p><code>performUnitOfWork</code> 和 <code>completeUnitOfWork</code> 函数用于迭代，主要的执行过程发生在 <code>beginWork</code> 和 <code>completeWork</code>函数中。</p><h3 id="commit-阶段" tabindex="-1"><a class="header-anchor" href="#commit-阶段" aria-hidden="true">#</a> <code>commit</code> 阶段</h3><center><p><img src="/blog/assets/commitRoot-729d1657.png" alt="图中标记3区域"></p></center><center>图中标记3区域</center><div class="code-tool-container language-javascript" data-ext="js"><div class="window-controls" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle class="" cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle><!----><!----></g></svg></div><div class="code-toolbox" data-ext="js"><!-- <Xicons icon="Edit" @click="handleEdit" /> --><!----><!----></div><!-- <CodeEditor v-if="isEdit" :size="size" v-bind="props" /> --><div class="code-content-container"><!--[--><pre class="language-javascript"><code><span class="token comment">// 省略部分代码</span>
<span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> renderPriorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">runWithPriority</span><span class="token punctuation">(</span>
    ImmediateSchedulerPriority<span class="token punctuation">,</span>
    <span class="token function">commitRootImpl</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitRootImpl</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* some works */</span>
  <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* some works */</span>
  <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* some works */</span>
  <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* some works */</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token comment">/* some works */</span>
  <span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* some works */</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* some works */</span>
  <span class="token keyword">const</span> flags <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
  <span class="token keyword">const</span> primaryFlags <span class="token operator">=</span> flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Update <span class="token operator">|</span> Deletion <span class="token operator">|</span> Hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">Placement</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">PlacementAndUpdate</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">Hydrating</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HydratingAndUpdate</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">Update</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">Deletion</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">commitDeletion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* some works */</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> committedLanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* some works */</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token function">commitLayoutEffectOnFiber</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> committedLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* some works */</span>
<span class="token punctuation">}</span>
</code></pre><!--]--><!----></div></div><p>在这个阶段，React 有两颗树和一个副作用列表，第一棵 <code>current</code> 树表示当前渲染在屏幕上的状态，之后在 <code>render</code> 阶段创建了一棵 <code>workInProgress</code> 树，表示需要被反馈到屏幕上的状态，这棵树和 <code>current</code> 树类似，都是通过 <code>child</code> 、<code>sibling</code> 和 <code>return</code> 指针连接。</p><p>副作用列表，它是 <code>workInProgress</code> 树中节点的子集，通过 <code>nextEffect</code> 指针连接，<strong>副作用列表是运行 <code>render</code> 阶段的结果</strong>。渲染的全部意义在于确定需要插入、更新或删除哪些节点以及需要调用哪些组件的生命周期方法。副作用列表保存了这些更改，也是在 <code>commit</code> 阶段需要迭代的一组节点。</p><blockquote><p>出于调试目的，<code>current</code> 树可以通过 <code>FiberRoot</code> 的 <code>current</code> 属性访问当前树， <code>workInProgress</code> 树可以通过 <code>current</code> 树中的 <code>HostFiber</code> 节点的 <code>alternate</code> 属性访问。</p></blockquote><p>上述代码主要会执行如下几个生命周期和节点更新：</p><ul><li>在标记了 <code>Snapshot</code> 副作用的节点上调用 <code>getSnapshotBeforeUpdate</code> 方法</li><li>在标记了 <code>Deletion</code> 副作用的节点上调用 <code>componentWillUnmount</code> 方法</li><li>执行所有的 DOM 插入、更新和删除</li><li>设置 <code>workInProgress</code> 树为 <code>current</code> 树</li><li>在标记了 <code>Placement</code> 副作用的节点上调用 <code>componentDidMount</code> 方法</li><li>在标记了 <code>Update</code> 副作用的节点上调用 <code>componentDidUpdate</code> 方法</li></ul><h4 id="before-mutation-阶段" tabindex="-1"><a class="header-anchor" href="#before-mutation-阶段" aria-hidden="true">#</a> <code>before mutation</code> 阶段</h4><p><code>commitBeforeMutationEffects</code> 执行 DOM 操作之前</p><p>会执行 <code>commitBeforeMutationEffectOnFiber</code> 并调用 <code>getSnapshotBeforeUpdate</code> 方法。</p><h4 id="mutation-阶段" tabindex="-1"><a class="header-anchor" href="#mutation-阶段" aria-hidden="true">#</a> <code>mutation</code> 阶段</h4><p><code>commitMutationEffects</code> 执行 DOM 操作时</p><p>会根据 Fiber 节点的对应状态执行对应的 <code>commit</code> 操作， 如：执行 <code>commitDeletion</code> 进而调用 <code>componentWillUnmount</code> 方法</p><h4 id="layout-阶段" tabindex="-1"><a class="header-anchor" href="#layout-阶段" aria-hidden="true">#</a> <code>layout</code> 阶段</h4><p><code>commitLayoutEffects</code> 执行 DOM 操作之后</p><p>会执行 <code>commitLayoutEffectOnFiber</code> 并调用 <code>componentDidMount</code> 、<code>componentDidUpdate</code> 方法</p></div><!--]--><!--[--><!--]--></div><!-- <PageMeta v-if="useMeta" /> --><!----><!--[--><!--[--><!--]--><div class="footer"><p> MIT Licensed | Copyright © 2020-present <a href="https://github.com/moriarty47" target="_blank" rel="noopener noreferrer"> Moriarty47 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" data-darkreader-inline-fill="" style="--darkreader-inline-fill:currentColor;"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9" data-darkreader-inline-fill="" style="--darkreader-inline-fill:currentColor;"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><!--]--></main><!--]--><div class="page-catalog-container"><h5 class="tip">FLOOR</h5><ul><!--[--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_2"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#架构" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="架构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="架构"><!--[-->架构<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu page-catalog-menu-depth_3"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#基本概念" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="基本概念"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="基本概念"><!--[-->基本概念<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#jsx" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="JSX"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="JSX"><!--[-->JSX<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#reactcomponent-与-reactelement-关系" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="ReactComponent 与 ReactElement 关系"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="ReactComponent 与 ReactElement 关系"><!--[-->ReactComponent 与 ReactElement 关系<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#jsx-与-fiber-关系" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="jsx 与 Fiber 关系"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="jsx 与 Fiber 关系"><!--[-->jsx 与 Fiber 关系<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#计数器简单实现" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="计数器简单实现"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="计数器简单实现"><!--[-->计数器简单实现<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#reactelement-与-fiber-节点-的关系" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="ReactElement 与 Fiber 节点 的关系"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="ReactElement 与 Fiber 节点 的关系"><!--[-->ReactElement 与 Fiber 节点 的关系<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#current-树-和-workinprogress-树" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="current 树 和 workInProgress 树"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="current 树 和 workInProgress 树"><!--[-->current 树 和 workInProgress 树<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#副作用-side-effects" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="副作用(Side-effects)"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="副作用(Side-effects)"><!--[-->副作用(Side-effects)<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#副作用表" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="副作用表"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="副作用表"><!--[-->副作用表<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#fiber-树的根节点" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="Fiber 树的根节点"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="Fiber 树的根节点"><!--[-->Fiber 树的根节点<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#fiber-节点数据结构" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="Fiber 节点数据结构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="Fiber 节点数据结构"><!--[-->Fiber 节点数据结构<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_2"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#算法" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="算法"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="算法"><!--[-->算法<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu page-catalog-menu-depth_3"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#render-阶段" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="render 阶段"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="render 阶段"><!--[-->render 阶段<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#工作流程的主要步骤" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="工作流程的主要步骤"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="工作流程的主要步骤"><!--[-->工作流程的主要步骤<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#performunitofwork-与-beginwork" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="performUnitOfWork 与 beginWork"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="performUnitOfWork 与 beginWork"><!--[-->performUnitOfWork 与 beginWork<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#completeunitofwork-与-completework" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="completeUnitOfWork 与 completeWork"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="completeUnitOfWork 与 completeWork"><!--[-->completeUnitOfWork 与 completeWork<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_3"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#commit-阶段" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="commit 阶段"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="commit 阶段"><!--[-->commit 阶段<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#before-mutation-阶段" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="before mutation 阶段"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="before mutation 阶段"><!--[-->before mutation 阶段<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#mutation-阶段" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="mutation 阶段"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="mutation 阶段"><!--[-->mutation 阶段<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu page-catalog-menu-depth_4"><a aria-current="page" href="/blog/JSBooks/JavaScript/React/architecture.html#layout-阶段" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="layout 阶段"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;" title="layout 阶段"><!--[-->layout 阶段<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--]--><!--]--></ul></div><!--]--></div><!----><!--]--></div>
    <div id="modal-container"></div>
    <div id="ctxmenu-container"></div>
    <script type="module" src="/blog/assets/app-bf7bc9cc.js" defer></script>
  </body>
</html>
